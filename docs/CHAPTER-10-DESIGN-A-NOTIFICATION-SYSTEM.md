# 第十章：设计一个通知系统 (Design A Notification System)

近年来，通知系统已经成为许多应用程序中非常流行的功能。通知向用户传递重要信息，如突发新闻、产品更新、事件、优惠等，已成为我们日常生活中不可或缺的一部分。在本章中，你将被要求设计一个通知系统。

通知不仅仅是移动推送通知。通知有三种主要的格式：移动推送通知、短信消息和电子邮件。图 10-1 显示了每种通知的示例。

![图10-1](/f10-1.png)

## 步骤 1 - 理解问题并确定设计范围
构建一个每天发送数百万条通知的可扩展系统并非易事。这需要对通知生态系统有深入的理解。这个面试问题有意设置得开放且模糊，需要你主动提问以澄清需求。

**候选人**：系统支持哪种类型的通知？  
**面试官**：推送通知、短信消息和电子邮件。  

**候选人**：这是一个实时系统吗？  
**面试官**：我们可以说这是一个软实时系统。我们希望用户尽快收到通知。然而，如果系统负载较高，稍微有些延迟是可以接受的。  

**候选人**：支持哪些设备？  
**面试官**：iOS 设备、安卓设备和笔记本/台式机。  

**候选人**：通知由什么触发？  
**面试官**：通知可以由客户端应用程序触发，也可以在服务器端进行调度。  

**候选人**：用户是否可以选择不接收通知？  
**面试官**：是的，选择退出的用户将不再接收通知。  

**候选人**：每天发送多少条通知？  
**面试官**：每天发送 1000 万条移动推送通知、100 万条短信和 500 万封电子邮件。

## 步骤 2 - 提出高层设计并达成共识
本节展示了支持多种通知类型的高层设计：iOS 推送通知、Android 推送通知、短信消息和电子邮件。其结构如下：

- 不同类型的通知
- 联系信息收集流程
- 通知发送/接收流程

### 不同类型的通知
我们首先从高层面来看每种通知类型是如何工作的。

#### iOS 推送通知
发送 iOS 推送通知主要需要三个组件：

![图10-2](/f10-2.png)

- **Provider（提供者）**：提供者构建并发送通知请求到 Apple 推送通知服务 (APNS)。构建推送通知时，提供者提供以下数据：
  - **设备令牌（Device token）**：用于发送推送通知的唯一标识符。
  - **有效载荷（Payload）**：这是一个包含通知有效载荷的 JSON 字典。以下是一个示例：
  ```
    {
      "aps": {
        "alert": {
          "title": "Game Request",
          "body": "Bob wants to play chess",
          "action-loc-key": "PLAY",
        },
        "badge": 5
      }
    }
  ```
  
- **APNS**：这是 Apple 提供的一个远程服务，用于将推送通知传递到 iOS 设备。
- **iOS 设备**：这是接收推送通知的终端客户端。

#### Android 推送通知
Android 采用类似的通知流程。不同之处在于，Android 设备通常使用 Firebase 云消息传递（Firebase Cloud Messaging, FCM）来发送推送通知，而不是使用 APNs。

![图10-3](/f10-3.png)

#### 短信消息
对于短信消息，通常使用第三方短信服务，如 Twilio [1]、Nexmo [2] 等。这些大多数都是商业服务。

![图10-4](/f10-4.png)

#### 电子邮件
尽管公司可以自行设置电子邮件服务器，许多公司选择使用商业电子邮件服务。Sendgrid [3] 和 Mailchimp [4] 是最受欢迎的电子邮件服务之一，它们提供更高的投递率和数据分析功能。

![图10-5](/f10-5.png)

图 10-6 显示了在包含所有第三方服务后的设计。

![图10-6](/f10-6.png)

### 联系信息收集流程
为了发送通知，我们需要收集移动设备令牌、电话号码或电子邮件地址。如图 10-7 所示，当用户安装我们的应用程序或首次注册时，API 服务器会收集用户的联系信息并将其存储在数据库中。

![图10-7](/f10-7.png)

图 10-8 显示了用于存储联系信息的简化数据库表。电子邮件地址和电话号码存储在用户表中，而设备令牌存储在设备表中。一个用户可以拥有多个设备，这意味着可以向该用户的所有设备发送推送通知。

![图10-8](/f10-8.png)


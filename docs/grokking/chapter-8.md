# 设计一个类似YouTube的视频共享服务

**类似服务**：netflix.com, vimeo.com, dailymotion.com, veoh.com  
**难度级别**：中等

## 1. 为什么是YouTube？
YouTube是全球最受欢迎的视频共享网站之一。用户可以在平台上上传、观看、分享、评分和举报视频，还可以在视频下添加评论。

## 2. 系统的需求和目标
为了简化设计，以下是我们要构建的一个简化版YouTube的需求：

**功能性需求：**

1. 用户应能上传视频。
2. 用户应能分享和观看视频。
3. 用户应能根据视频标题进行搜索。
4. 系统应能记录视频的统计数据，例如点赞/点踩数量、观看次数等。
5. 用户应能在视频下添加和查看评论。

**非功能性需求：**  

1. 系统应具有高可靠性，确保任何上传的视频都不会丢失。
2. 系统应具有高可用性。为了保证可用性，允许牺牲一定程度的一致性；若用户暂时无法看到某个视频，可以接受。
3. 用户在观看视频时应有实时体验，不应感到任何延迟。

**不在范围内：** 视频推荐、最受欢迎的视频、频道、订阅、稍后观看、收藏夹等功能。

## 3. 容量估算与约束

假设我们有15亿总用户，其中8亿是日活跃用户。如果平均每个用户每天观看5个视频，那么总视频观看量每秒将为：

`800M * 5 / 86400秒 ≈ 46K视频/秒`

假设我们的视频上传与观看比为1:200，即每上传一个视频有200次观看，这样每秒有230个视频上传：

`46K / 200 ≈ 230视频/秒`

**存储估算**：假设每分钟有500小时的视频上传到YouTube。如果平均每分钟视频需要50MB的存储空间（视频需要存储为多种格式），那么每分钟上传视频所需的总存储量为：

`500小时 * 60分钟 * 50MB ≈ 1500 GB/分钟（25 GB/秒）`

以上估算未考虑视频压缩和复制，这些因素会影响我们的估算结果。

**带宽估算**：每分钟上传500小时视频，假设每分钟的视频上传占用10MB带宽，我们每分钟的上传量将为300GB：

`500小时 * 60分钟 * 10MB ≈ 300GB/分钟（5GB/秒）`

假设上传与观看的比率为1:200，我们每秒需要1TB的输出带宽。

## 4. 系统API

我们可以使用SOAP或REST API来暴露服务的功能。以下是上传和搜索视频API的定义：

```
uploadVideo(api_dev_key, video_title, video_description, tags[], category_id, default_language, recording_details, video_contents)
```

**上传API参数**：
- `api_dev_key` (string)：已注册账号的API开发密钥，用于限制用户访问频率，基于其分配的配额。
- `video_title` (string)：视频标题。
- `video_description` (string)：视频的可选描述。
- `tags` (string[])：视频的可选标签。
- `category_id` (string)：视频类别，例如电影、歌曲、人物等。
- `default_language` (string)：视频语言，例如英语、普通话、印地语等。
- `recording_details` (string)：视频录制的地点。
- `video_contents` (stream)：要上传的视频内容。

**返回**： (string)  
成功上传会返回HTTP 202（请求已接受），视频编码完成后，系统通过电子邮件通知用户，并提供访问视频的链接。我们还可以提供可查询的API，让用户了解其上传视频的当前状态。

```
searchVideo(api_dev_key, search_query, user_location, maximum_videos_to_return, page_token)
```

**搜索API参数**：
- `api_dev_key` (string)：已注册账号的API开发密钥。
- `search_query` (string)：包含搜索词的字符串。
- `user_location` (string)：执行搜索的用户位置（可选）。
- `maximum_videos_to_return` (number)：单次请求返回的最大结果数量。
- `page_token` (string)：用于指定应返回结果集中的某一页面的标记。

**返回**： (JSON)  
返回包含与搜索查询匹配的视频资源列表的JSON。每个视频资源包括视频标题、缩略图、视频创建日期和观看次数。

```
streamVideo(api_dev_key, video_id, offset, codec, resolution)
```

**流媒体API参数**：
- `api_dev_key` (string)：已注册账号的API开发密钥。
- `video_id` (string)：视频的标识字符串。
- `offset` (number)：允许从视频的任何偏移位置流式播放，此偏移量为从视频开始的秒数。如果支持在多个设备上播放/暂停视频，则需要在服务器上存储该偏移量，使用户在任意设备上从上次观看的时间点继续播放视频。
- `codec` (string) & `resolution` (string)：客户端API需传递编解码器和分辨率信息，以支持多个设备的播放/暂停功能。例如，当用户在电视的Netflix应用上观看视频时暂停，再切换到手机上的Netflix应用继续观看，此时需要编解码器和分辨率信息，因为不同设备的分辨率和使用的编解码器不同。

**返回**： (STREAM)  
从指定的偏移位置开始的视频媒体流（视频片段）。

## 5. 高层设计

从高层次来看，我们需要以下组件：

1. **处理队列**：每个上传的视频将被推送到处理队列中，稍后会从队列中取出进行编码、缩略图生成和存储。
2. **编码器**：用于将每个上传的视频编码为多种格式。
3. **缩略图生成器**：用于为每个视频生成几个缩略图。
4. **视频和缩略图存储**：用于将视频和缩略图文件存储在分布式文件存储系统中。
5. **用户数据库**：用于存储用户信息，例如姓名、电子邮件、地址等。
6. **视频元数据存储**：一个元数据库，用于存储关于视频的所有信息，如标题、系统中的文件路径、上传用户、总观看次数、点赞、点踩等。同时，也用于存储所有视频评论。

![图8-1](/grokking/f8-1.png)

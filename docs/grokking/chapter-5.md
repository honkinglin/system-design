# 设计Dropbox

我们来设计一个类似于Dropbox或Google Drive的文件托管服务。云文件存储使用户能够将数据存储在远程服务器上。这些服务器通常由云存储提供商维护，并通过网络（通常是互联网）供用户访问。用户按月为他们的云数据存储付费。

**类似服务**：OneDrive、Google Drive  
**难度级别**：中等

## 1. 为什么选择云存储？

云文件存储服务近年来变得非常流行，因为它们简化了多设备之间的数字资源存储和交换。人们从使用单一的个人计算机转向多设备的趋势——包括不同平台和操作系统的智能手机和平板电脑，这些设备可以随时随地便携式访问——被认为是云存储服务迅速普及的原因。以下是此类服务的一些主要优点：

- **可用性**：云存储服务的口号是“随时随地的数据可用性”。用户可以在任何设备上随时随地访问他们的文件或照片。
- **可靠性和持久性**：云存储的另一个优点是它提供100%的数据可靠性和持久性。通过在不同地理位置的服务器上存储多个数据副本，云存储确保用户不会丢失数据。
- **可扩展性**：用户永远不必担心存储空间不足。使用云存储，您可以根据需求获得无限的存储空间，只要您愿意支付相应的费用。

如果您还没有使用过 [Dropbox.com](https://www.dropbox.com/)，我们强烈建议您创建一个帐户，上传或编辑文件，并浏览他们服务提供的各种选项。这将有助于您更好地理解本章内容。

## 2. 系统的需求与目标

>💡 在面试开始时应当明确需求，确保通过提问来弄清面试官对系统的确切范围设想。

云存储系统的目标是什么？以下是我们系统的顶层需求：

1. 用户应能够在任意设备上上传和下载其文件或照片。
2. 用户应能够与其他用户共享文件或文件夹。
3. 我们的服务应支持设备间的自动同步，即在一台设备上更新文件后，应在所有设备上同步。
4. 系统应支持存储最大1GB的大文件。
5. 需要支持ACID特性。应保证所有文件操作的原子性、一致性、隔离性和持久性。
6. 系统应支持离线编辑。用户应能够在离线状态下添加、删除或修改文件，并在恢复在线后将所有更改同步到远程服务器和其他在线设备。

**扩展需求**  
- 系统应支持数据快照功能，使用户可以回溯到文件的任何版本。

## 3. 设计考虑

- 预期有大量的读写操作。
- 读写比率预计几乎相同。
- 文件可以以小部分或块（如4MB）的形式存储，这样可以带来许多好处，例如：对于失败的操作只需重试文件的小块部分。如果用户上传文件失败，则只需重试失败的块。
- 通过仅传输更新的块，可以减少数据交换量。
- 删除重复的块可以节省存储空间和带宽。
- 在客户端保留元数据（文件名、大小等）的本地副本可以减少大量与服务器的往返请求。
- 对于小的更改，客户端可以智能地仅上传差异数据而非整个块。

## 4. 容量估算与约束

- 假设我们共有5亿用户，其中1亿为日活跃用户（DAU）。
- 假设每位用户平均通过三台不同的设备连接。
- 如果每位用户平均拥有200个文件或照片，总文件数将达到1000亿。
- 假设平均文件大小为100KB，则总存储量为10PB。

  `1000亿 * 100KB = 10PB`

- 假设每分钟有一百万个活跃连接。

![图5-1](/grokking/f5-1.png)

## 5. 高级设计

用户将在其设备上指定一个文件夹作为工作空间，放置在此文件夹中的任何文件、照片或文件夹将被上传至云端。每当文件被修改或删除时，相应更改将同步至云存储。用户可以在其所有设备上指定类似的工作空间，并且在某个设备上的任何修改都会传播到所有其他设备，以便在各处保持工作空间一致。

在高层设计上，我们需要存储文件及其元数据，例如文件名、文件大小、目录等，以及与谁共享该文件。因此，我们需要一些服务器来帮助客户端将文件上传/下载至云存储，同时也需要一些服务器来更新文件和用户的元数据信息。此外，还需要某种机制来通知所有客户端每当有更新发生时，以便它们能够同步文件。

如图所示，块服务器将与客户端协同工作，从云存储上传/下载文件；元数据服务器将使用SQL或NoSQL数据库保持文件元数据的更新。同步服务器将处理通知所有客户端不同更改的工作流，以实现同步。

![图5-2](/grokking/f5-2.png)


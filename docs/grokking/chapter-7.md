# 设计 Twitter

我们来设计一个类似 Twitter 的社交网络服务。用户可以发布推文、关注他人并收藏推文。

难度级别：中等

## 1. 什么是 Twitter？
Twitter 是一个在线社交网络服务，用户可以发布和阅读长度为 140 字符的短消息，称为“推文”。注册用户可以发布和阅读推文，未注册用户只能阅读推文。用户可以通过网站、短信或移动应用访问 Twitter。

## 2. 系统的需求与目标
我们将设计一个简化版的 Twitter，包含以下需求：

### 功能性需求
1. 用户可以发布新推文。
2. 用户可以关注其他用户。
3. 用户可以将推文标记为收藏。
4. 系统应能创建并显示用户时间线，包含用户关注的所有人的热门推文。
5. 推文可以包含照片和视频。

### 非功能性需求
1. 系统需要高度可用。
2. 时间线生成的可接受延迟为 200 毫秒。
3. 在可用性优先的情况下，系统的强一致性要求可以适当降低；如果用户暂时看不到某条推文，可以接受。

### 拓展需求
1. 推文搜索。
2. 回复推文。
3. 热门话题——当前热点话题/搜索。
4. @用户标签。
5. 推文通知。
6. 关注建议。
7. “时刻”功能。

## 3. 容量估算与限制

假设我们有10亿用户，总共有2亿日活跃用户（DAU）。另外假设每天有1亿条新推文，每个用户平均关注200人。

**每天的点赞次数？**

如果每个用户平均每天点赞五次，那么我们将有：

`2亿用户 * 5 次点赞 => 10亿次点赞`

**系统每天会产生多少次推文查看？**

假设用户平均每天访问时间线两次，并访问其他五个人的页面。在每个页面上，用户看到20条推文，那么系统每天将产生280亿次推文查看：

`2亿日活跃用户 * ((2 + 5) * 20条推文) => 280亿次/天`

**存储估算**

假设每条推文有140个字符，存储字符时不进行压缩，每个字符需要2字节。假设每条推文需要30字节存储元数据（如ID、时间戳、用户ID等）。我们需要的总存储量为：

`1亿条 * (280 + 30)字节 => 30GB/天`

**我们五年的存储需求会是多少？**

用户数据、关注、点赞的数据需求是多少？我们将留给练习解答。

并非所有推文都包含媒体内容，假设平均每五条推文包含一张照片，每十条推文包含一个视频。再假设每张照片平均大小为200KB，每个视频大小为2MB。那么每天新增的媒体内容为24TB：

`(1亿/5 张照片 * 200KB) + (1亿/10 个视频 * 2MB) ≈ 24TB/天`

**带宽估算**

由于每天的总输入量为24TB，这相当于290MB/秒。

记住我们每天有280亿次推文查看。我们必须显示每条推文的照片（如果有照片），假设用户在时间线上每三次观看中有一次观看视频。因此，总输出量将是：
```
(280亿 * 280字节) / 86400秒 文本 => 93MB/秒 
+ (280亿/5 * 200KB ) / 86400秒 照片 => 13GB/秒 
+ (280亿/10/3 * 2MB ) / 86400秒 视频 => 22GB/秒  

总计约为 35GB/秒
```





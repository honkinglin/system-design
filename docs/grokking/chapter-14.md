# 设计 Yelp 或附近的朋友

我们来设计一个类似 Yelp 的服务，用户可以搜索附近的地点，如餐馆、剧院或购物中心等，并可以添加/查看这些地点的评论。  

**类似服务**：邻近服务器（Proximity Server）  
**难度级别**：困难  

## 1. 为什么是 Yelp 或邻近服务器？  

邻近服务器用于发现附近的景点，如场所、活动等。如果你以前没有使用过 [yelp.com](https://www.yelp.com/)，请在继续之前试用一下（你可以搜索附近的餐馆、剧院等），并花些时间了解网站提供的不同功能。这将有助于更好地理解本章内容。  

## 2. 系统的需求和目标  

我们希望从类似 Yelp 的服务中实现哪些功能？  

该服务将存储不同地点的信息，以便用户可以搜索它们。当用户查询时，我们的服务将返回用户周围的地点列表。  

**功能性需求**  
1. 用户应该能够 **添加/删除/更新** 地点。  
2. 根据用户的位置（**经度/纬度**），系统应该能够在给定半径内找到所有附近的地点。  
3. 用户应该能够 **添加反馈/评论**，包括图片、文本和评分。  

**非功能性需求**  
1. 用户应当能获得 **实时搜索体验**，搜索延迟应尽可能低。  
2. 该服务应支持 **高并发搜索**，搜索请求的数量将远远超过新增地点的请求。  

## 3. 规模估算  

假设系统存储 **5 亿**（500M）个地点，并且每秒需要处理 **10 万**（100K）次查询请求（QPS）。此外，我们假设地点数量和查询请求量每年增长 **20%**。  

## 4. 数据库模式设计  

每个地点（Location）可包含以下字段：  

| 字段 | 数据类型 | 大小（字节） | 说明 |
|------|--------|---------|------|
| LocationID | 8 bytes | 8 | 唯一标识一个地点 |
| Name | 256 bytes | 256 | 地点名称 |
| Latitude | 8 bytes | 8 | 纬度 |
| Longitude | 8 bytes | 8 | 经度 |
| Description | 512 bytes | 512 | 地点描述 |
| Category | 1 byte | 1 | 分类（如咖啡店、餐馆、剧院等） |

尽管一个 **4 字节** 的数值足以唯一标识 5 亿个地点，但考虑到未来的增长，我们采用 **8 字节** 的 `LocationID`。  

**总大小**：  
**8 + 256 + 8 + 8 + 512 + 1 = 793 字节**  

此外，我们需要存储地点的 **评论、照片和评分**。可以使用单独的表来存储地点的评论信息：  

| 字段 | 数据类型 | 大小（字节） | 说明 |
|------|--------|---------|------|
| LocationID | 8 bytes | 8 | 关联的地点 ID |
| ReviewID | 4 bytes | 4 | 唯一标识评论（假设单个地点不会超过 2³² 条评论） |
| ReviewText | 512 bytes | 512 | 评论内容 |
| Rating | 1 byte | 1 | 评分（10 分制） |

同样，我们可以使用单独的表来存储 **地点和评论的照片**。
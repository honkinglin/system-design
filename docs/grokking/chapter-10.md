# 设计API限流器  

我们来设计一个API限流器，用于根据用户发送请求的数量进行限流。  

**难度级别：中等**  

## 1. 什么是限流器？  
假设我们有一个服务正在接收大量请求，但只能处理有限数量的每秒请求。为了解决这一问题，我们需要某种限流机制，允许在特定时间内仅接收一定数量的请求，以确保服务能够正常响应所有请求。  

从高层次来看，限流器限制一个实体（用户、设备、IP等）在特定时间窗口内可以执行的事件数量。例如：  
- 用户每秒只能发送一条消息。  
- 用户每天最多允许三次信用卡交易失败。  
- 单个IP每天只能创建二十个账户。  

通常，限流器会限制发送方在特定时间窗口内发出的请求数量，并在达到限制时阻止后续请求。

## 2. 为什么需要API限流？  
限流有助于保护服务免受针对应用层的滥用行为，例如拒绝服务（DOS）攻击、暴力破解密码、暴力破解信用卡交易等。这些攻击通常表现为大量的HTTP/S请求，看似来自真实用户，但通常是由机器（或机器人）生成的。因此，这些攻击通常更难被检测到，且更容易让服务、应用或API崩溃。  

限流还用于防止收入损失、减少基础设施成本、阻止垃圾邮件和防止在线骚扰。以下是一些可以通过限流使服务（或API）更可靠的场景：  

- **行为不当的客户端/脚本**：无论是故意还是无意，一些实体可能通过发送大量请求使服务超负荷运行。另一个场景是用户发送大量低优先级的请求，我们希望确保这些请求不会影响到高优先级的流量。例如，发送大量请求以获取分析数据的用户不应妨碍其他用户的关键交易。  
- **安全性**：通过限制用户可以进行的二次验证尝试次数（如2FA中的错误密码尝试次数），可以有效防止暴力破解。  
- **防止滥用行为和糟糕的设计实践**：如果没有API限流，客户端应用的开发者可能会使用不良的开发策略，例如不断重复请求相同的信息。  
- **控制成本和资源使用**：服务通常是为正常的输入行为设计的，例如用户每分钟发布一条帖子。计算机可以轻松通过API推送成千上万的请求。限流器能够控制服务API的访问频率。  
- **收入**：某些服务可能希望根据客户服务的层级来限制操作，并基于限流创建收入模型。对于服务提供的所有API，可以设定默认的请求限制。超出限制时，用户需要购买更高的限额。  
- **消除流量波动**：确保服务为所有用户保持可用，避免流量尖峰影响其他用户的体验。

# 第十五章：设计 Google Drive

近年来，云存储服务如Google Drive、Dropbox、Microsoft OneDrive和Apple iCloud变得非常流行。在本章中，您将被要求设计Google Drive。

在开始设计之前，让我们先花一点时间了解Google Drive。Google Drive是一个文件存储和同步服务，帮助您在云中存储文档、照片、视频和其他文件。您可以从任何计算机、智能手机和平板电脑访问您的文件。您可以轻松地与朋友、家人和同事共享这些文件 [1]。图15-1和图15-2展示了Google Drive在浏览器和移动应用中的外观。

![图15-1](/f15-1.png)

![图15-2](/f15-2.png)

## 第 1 步 - 理解问题并建立设计范围

设计一个Google Drive是一个大项目，因此重要的是提出问题以缩小范围。

**候选人**：最重要的功能是什么？  
**面试官**：上传和下载文件、文件同步以及通知。

**候选人**：这是一个移动应用、网页应用还是两者都有？  
**面试官**：两者都有。

**候选人**：支持哪些文件格式？  
**面试官**：任何文件类型。

**候选人**：文件需要加密吗？  
**面试官**：是的，存储中的文件必须加密。

**候选人**：文件大小有限制吗？  
**面试官**：是的，文件必须小于10 GB。

**候选人**：产品有多少用户？  
**面试官**：1000万日活跃用户（DAU）。

在本章中，我们关注以下功能：
- **添加文件**：添加文件的最简单方式是将文件拖放到Google Drive中。
- **下载文件**。
- **在多个设备间同步文件**：当一个设备上添加文件时，文件会自动同步到其他设备。
- **查看文件版本**。
- **与朋友、家人和同事共享文件**。
- **在文件被编辑、删除或与您共享时发送通知**。

本章未讨论的功能包括：
- **Google文档编辑和协作**：Google文档允许多人同时编辑同一文档。这不在我们的设计范围内。

除了明确需求外，了解非功能性需求也很重要：
- **可靠性**：对于存储系统，可靠性至关重要。数据丢失是不可接受的。
- **快速同步速度**：如果文件同步耗时过长，用户会变得不耐烦并放弃该产品。
- **带宽使用**：如果产品占用大量不必要的网络带宽，用户会不满，尤其是在使用移动数据计划时。
- **可扩展性**：系统应能够处理高流量。
- **高可用性**：当某些服务器离线、速度变慢或发生意外网络错误时，用户仍应能够使用系统。

### 粗略估算
- 假设应用有5000万注册用户和1000万日活跃用户。
- 用户获得10 GB的免费存储空间。
- 假设用户每天上传2个文件。平均文件大小为500 KB。
- 读写比例为1:1。
- 总分配空间：5000万 * 10 GB = 500 PB。
- 上传API的每秒查询数（QPS）：1000万 * 2次上传 / 24小时 / 3600秒 = ~240。
- 峰值QPS = QPS * 2 = 480。

## 第 2 步 - 提出高层设计并获得认可

我们将采用一种略微不同的方法，而不是一开始就展示高层设计图。我们将从一个简单的开始：在单个服务器上构建一切。然后，逐步扩展以支持数百万用户。通过这种练习，可以帮助您回忆起书中讨论的一些重要主题。

让我们从单服务器设置开始，如下所示：
- **一个Web服务器**，用于上传和下载文件。
- **一个数据库**，用于跟踪元数据，如用户数据、登录信息、文件信息等。
- **一个存储系统**，用于存储文件。我们分配1TB的存储空间来存储文件。

我们花了几个小时设置Apache Web服务器、MySQL数据库以及一个名为`drive/`的目录，作为存储上传文件的根目录。在`drive/`目录下，有一个目录列表，称为命名空间。每个命名空间包含该用户上传的所有文件。服务器上的文件名与原始文件名保持一致。每个文件或文件夹可以通过连接命名空间和相对路径唯一标识。

图15-3展示了`/drive`目录的左侧示例及其右侧的展开视图。

![图15-3](/f15-3.png)

### APIs
API的设计是什么样的？我们主要需要三个API：上传文件、下载文件和获取文件版本。

1. **上传文件到Google Drive**
   支持两种类型的上传：
   - **简单上传**：当文件大小较小时使用此上传类型。
   - **可恢复上传**：当文件大小较大且网络中断的可能性较高时使用此上传类型。

   可恢复上传API示例：
   ```
   https://api.example.com/files/upload?uploadType=resumable
   ```
   参数：
   - `uploadType=resumable`
   - `data`：要上传的本地文件。

   可恢复上传通过以下三步实现 [2]：
   - 发送初始请求以检索可恢复的URL。
   - 上传数据并监控上传状态。
   - 如果上传受到干扰，恢复上传。

2. **从Google Drive下载文件**
   示例API：
   ```
   https://api.example.com/files/download
   ```
   参数：
   - `path`：下载文件的路径。

   示例参数：
   ```json
   {
     "path": "/recipes/soup/best_soup.txt"
   }
   ```

3. **获取文件版本**
   示例API：
   ```
   https://api.example.com/files/list_revisions
   ```
   参数：
   - `path`：您想获取版本历史记录的文件路径。
   - `limit`：返回的最大版本数。

   示例参数：
   ```json
   {
     "path": "/recipes/soup/best_soup.txt",
     "limit": 20
   }
   ```

所有API都需要用户身份验证，并使用HTTPS。安全套接层（SSL）保护客户端与后端服务器之间的数据传输。

### 从单服务器迁移

随着上传的文件增多，最终会收到空间不足的警告，如图15-4所示。

![图15-4](/f15-4.png)

只有10MB的存储空间剩余！这是一个紧急情况，因为用户无法再上传文件。第一个想到的解决方案是对数据进行分片，以便将其存储在多个存储服务器上。图15-5展示了基于`user_id`的分片示例。

![图15-5](/f15-5.png)

你通宵达旦地设置了数据库分片并密切监控，一切又恢复正常。你已扑灭了这场火灾，但仍然担心在存储服务器出现故障时可能会造成数据丢失。你问了问你的后端专家朋友Frank，他告诉你许多领先公司（如Netflix和Airbnb）都使用Amazon S3进行存储。“Amazon简单存储服务（Amazon S3）是一种对象存储服务，提供行业领先的可扩展性、数据可用性、安全性和性能” [3]。你决定进行一些研究，看看这是否适合。

经过大量阅读，你对S3存储系统有了良好的理解，并决定将文件存储在S3中。Amazon S3支持同一区域和跨区域复制。区域是Amazon Web Services（AWS）拥有数据中心的地理区域。如图15-6所示，数据可以在同一区域（左侧）和跨区域（右侧）进行复制。冗余文件存储在多个区域，以防止数据丢失并确保可用性。存储桶类似于文件系统中的文件夹。

![图15-6](/f15-6.png)

将文件放入S3后，你终于可以安心睡觉，不用担心数据丢失。为了防止未来发生类似问题，你决定进一步研究可以改进的领域。以下是你发现的一些领域：
- **负载均衡器**：添加负载均衡器以分配网络流量。负载均衡器确保流量均匀分配，如果某个Web服务器宕机，它将重新分配流量。
- **Web服务器**：在添加负载均衡器后，可以根据流量负载轻松增加/删除更多Web服务器。
- **元数据数据库**：将数据库移出服务器以避免单点故障。同时，设置数据复制和分片以满足可用性和可扩展性要求。
- **文件存储**：使用Amazon S3进行文件存储。为确保可用性和耐用性，文件在两个独立的地理区域中进行复制。

在应用上述改进后，你成功地将Web服务器、元数据数据库和文件存储与单个服务器解耦。更新后的设计如图15-7所示。

![图15-7](/f15-7.png)

### 同步冲突  (Sync conflicts)

对于像Google Drive这样的大型存储系统，偶尔会发生同步冲突。当两个用户同时修改同一个文件或文件夹时，就会发生冲突。我们如何解决这个冲突？我们的策略是：第一个被处理的版本获胜，后处理的版本将收到冲突。图15-8展示了一个同步冲突的示例。

![图15-8](/f15-8.png)

在图15-8中，用户1和用户2尝试同时更新同一个文件，但用户1的文件首先被我们的系统处理。用户1的更新操作通过了，但用户2遇到了同步冲突。那么我们如何为用户2解决这个冲突呢？我们的系统会同时呈现两个相同文件的副本：用户2的本地副本和来自服务器的最新版本（见图15-9）。用户2可以选择合并两个文件或用一个版本覆盖另一个版本。

![图15-9](/f15-9.png)

当多个用户同时编辑同一个文档时，保持文档同步是具有挑战性的。感兴趣的读者可以参考相关材料 [4] [5]。

### 高层设计  

图15-10展示了提议的高层设计。让我们逐个检查系统的各个组件。

![图15-10](/f15-10.png)

**用户**：用户可以通过浏览器或移动应用程序使用该应用。

**块服务器**：块服务器将数据块上传到云存储。块存储（也称为块级存储）是一种在云环境中存储数据文件的技术。一个文件可以分成多个数据块，每个块都有一个唯一的哈希值，存储在我们的元数据数据库中。每个数据块被视为一个独立的对象，并存储在我们的存储系统（S3）中。为了重构一个文件，这些数据块会按特定顺序组合。至于块的大小，我们以Dropbox为参考：它将块的最大大小设定为4MB [6]。

**云存储**：文件被拆分成更小的数据块并存储在云存储中。

**冷存储**：冷存储是一种用于存储不活跃数据的计算机系统，这意味着文件在很长时间内未被访问。

**负载均衡器**：负载均衡器在API服务器之间均匀分配请求。

**API服务器**：这些服务器几乎负责除了上传流程以外的所有操作。API服务器用于用户身份验证、管理用户资料、更新文件元数据等。

**元数据数据库**：它存储用户、文件、数据块、版本等的元数据。请注意，文件存储在云中，而元数据数据库仅包含元数据。

**元数据缓存**：部分元数据被缓存以实现快速检索。

**通知服务**：这是一个发布/订阅系统，允许数据在特定事件发生时从通知服务传输到客户端。在我们的具体案例中，通知服务会在文件被添加、编辑或移除时通知相关客户端，以便它们可以拉取最新的更改。

**离线备份队列**：如果客户端处于离线状态，无法拉取最新的文件更改，离线备份队列将存储信息，以便在客户端上线时同步这些更改。

我们已经从高层次讨论了Google Drive的设计。一些组件比较复杂，值得仔细检查；我们将在深入讨论中详细讨论这些内容。

